<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Place Order</title>
    <link rel="stylesheet" th:href="@{/style.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
<a class="btn admin-tab" th:href="@{/admin}"><i class="fas fa-user-shield"></i> Admin</a>

<header>
    <a th:href="@{/}"><i class="fas fa-home"></i> Home</a>
    <a class="active" th:href="@{/order}"><i class="fas fa-utensils"></i> Order</a>
    <a th:href="@{/orders}"><i class="fas fa-clock-rotate-left"></i> Past Orders</a>
    <a th:href="@{/contact}"><i class="fas fa-phone-alt"></i> Contact</a>
</header>

<div class="order-card">
    <h2><i class="fas fa-burger"></i> Build Your Order</h2>

    <div class="order-layout">
        <div>
            <div class="input-group">
                <label for="category">Category</label>
                <select id="category" onchange="updateMenu()"></select>
            </div>

            <div class="input-group">
                <label for="food">Food Item</label>
                <select id="food" onchange="updateFoodPreview()"></select>
            </div>

            <div class="food-preview" id="foodPreview">
                <img id="foodPreviewImage" class="food-preview-image" alt="Selected dish image" loading="lazy">
                <div class="food-preview-text">
                    <strong id="foodPreviewName">Select a dish</strong>
                    <span id="foodPreviewPrice">Price will appear here</span>
                </div>
            </div>

            <div class="input-group">
                <label for="quantity">Quantity</label>
                <input type="number" id="quantity" min="1" value="1">
            </div>

            <button class="add-btn" onclick="addItem()"><i class="fas fa-plus-circle"></i> Add Item</button>
        </div>

        <div class="order-summary">
            <h3><i class="fas fa-list-check"></i> Cart Summary</h3>
            <ul id="orderList"></ul>
            <div class="total-row">
                <span>Total</span>
                <span>Rs. <span id="totalAmount">0</span></span>
            </div>
            <div class="order-actions">
                <button type="button" class="ghost-btn" onclick="removeLastItem()"><i class="fas fa-rotate-left"></i> Remove Last</button>
                <button type="button" class="ghost-btn" onclick="clearCart()"><i class="fas fa-trash"></i> Clear Cart</button>
            </div>
        </div>
    </div>

    <form th:action="@{/bill}" method="post" onsubmit="return validateCheckout();">
        <input type="hidden" name="itemsSummary" id="itemsSummary">
        <input type="hidden" name="itemCount" id="itemCount">
        <input type="hidden" name="totalAmount" id="finalTotalAmount">
        <button type="submit" class="bill-btn"><i class="fas fa-receipt"></i> Checkout and Generate Bill</button>
    </form>

    <div class="notice" id="orderNotice">Tip: add multiple items, then checkout once to save one complete order.</div>
</div>

<script>
    const menu = {};
    const foodImages = {
        dosa: "https://images.unsplash.com/photo-1668236543090-82eba5ee5976?auto=format&fit=crop&w=320&q=80",
        meals: "https://cdn.dotpe.in/longtail/store-items/8401991/knzYqy3m.jpeg",
        idly: "https://jbsite-11e9c.kxcdn.com/Ayurveda/images/content/778-Idly.jpg",
         
        rasam: "https://www.ice.edu/sites/default/files/inline-images/rasam%20web.jpg",
        "chicken biryani": "https://vismaifood.com/storage/app/uploads/public/e12/7b7/127/thumb__1200_0_0_0_auto.jpg",
        "mutton biryani": "https://www.cubesnjuliennes.com/wp-content/uploads/2021/03/Best-Mutton-Biryani-Recipe.jpg",
        "egg parotta": "https://i.ytimg.com/vi/Xz31ahbF9FA/maxresdefault.jpg",
        "fish gravy": "https://i.ytimg.com/vi/_-jMA-rD16k/maxresdefault.jpg",
        "fish fry": "https://butteroverbae.com/wp-content/uploads/2018/11/spicy-fish-fry-served.jpg",
        "orange juice": "https://images.unsplash.com/photo-1600271886742-f049cd451bba?auto=format&fit=crop&w=320&q=80",
        "lemon juice": "https://images.unsplash.com/photo-1621263764928-df1444c5e859?auto=format&fit=crop&w=320&q=80",
        "pineapple juice": "https://pallibangla.com/wp-content/uploads/2024/06/pineapple-juice-1-600x450.jpg"
        
    };
    const fallbackFoodImage = "https://i.ytimg.com/vi/_-jMA-rD16k/maxresdefault.jpg";
    
    let totalAmount = 0;
    let totalItems = 0;
    const orderLines = [];
    const orderLineTotals = [];
    const orderLineQty = [];

    function normalizeFoodKey(name) {
        return name
            .replace(/^[^a-zA-Z0-9]+/, "")
            .trim()
            .toLowerCase();
    }

    function getFoodImage(name) {
        return foodImages[normalizeFoodKey(name)] || fallbackFoodImage;
    }

    function updateFoodPreview() {
        const foodSelect = document.getElementById("food");
        const previewImage = document.getElementById("foodPreviewImage");
        const previewName = document.getElementById("foodPreviewName");
        const previewPrice = document.getElementById("foodPreviewPrice");

        if (!foodSelect.options.length) {
            previewImage.src = fallbackFoodImage;
            previewName.textContent = "No dish available";
            previewPrice.textContent = "";
            return;
        }

        const selectedText = foodSelect.options[foodSelect.selectedIndex].text;
        const foodName = selectedText.split(" - ")[0];
        const unitPrice = parseInt(foodSelect.value, 10);

        previewImage.src = getFoodImage(foodName);
        previewName.textContent = foodName;
        previewPrice.textContent = `Rs. ${unitPrice}`;
    }

    function updateMenu() {
        const category = document.getElementById("category").value;
        const foodSelect = document.getElementById("food");
        foodSelect.innerHTML = "";

        (menu[category] || []).forEach(item => {
            const option = document.createElement("option");
            option.value = item.price;
            option.textContent = `${item.name} - Rs. ${item.price}`;
            foodSelect.appendChild(option);
        });
        updateFoodPreview();
    }

    async function loadMenu() {
        try {
            const response = await fetch("/api/dishes");
            if (!response.ok) throw new Error("menu load failed");
            const dishes = await response.json();

            Object.keys(menu).forEach(key => delete menu[key]);
            const categorySelect = document.getElementById("category");
            categorySelect.innerHTML = "";

            dishes.forEach(dish => {
                if (!menu[dish.category]) {
                    menu[dish.category] = [];
                    const catOption = document.createElement("option");
                    catOption.value = dish.category;
                    catOption.textContent = dish.category;
                    categorySelect.appendChild(catOption);
                }
                menu[dish.category].push({ name: dish.name, price: dish.price });
            });

            updateMenu();
        } catch (e) {
            setNotice("Unable to load menu from database.", true);
        }
    }

    function addItem() {
        const foodSelect = document.getElementById("food");
        const quantity = parseInt(document.getElementById("quantity").value, 10);

        if (!quantity || quantity <= 0 || foodSelect.options.length === 0) {
            setNotice("Enter a valid quantity and select a dish.", true);
            return;
        }

        const unitPrice = parseInt(foodSelect.value, 10);
        const foodName = foodSelect.options[foodSelect.selectedIndex].text.split(" - ")[0];
        const lineTotal = unitPrice * quantity;

        totalAmount += lineTotal;
        totalItems += quantity;

        orderLineTotals.push(lineTotal);
        orderLineQty.push(quantity);
        orderLines.push(`${foodName} x${quantity} (Rs. ${lineTotal})`);

        const li = document.createElement("li");
        const imageSrc = getFoodImage(foodName);
        li.innerHTML = `<img class="order-food-image" src="${imageSrc}" alt="${foodName}" loading="lazy"><span>${foodName}</span><span style="margin-left:auto;">x${quantity}</span><span class="status-pill">Rs. ${lineTotal}</span>`;
        document.getElementById("orderList").appendChild(li);

        syncHiddenFields();
        document.getElementById("quantity").value = 1;
        setNotice("Item added to cart.", false);
    }

    function removeLastItem() {
        if (orderLines.length === 0) {
            setNotice("Cart is already empty.", true);
            return;
        }

        const lastTotal = orderLineTotals.pop();
        const lastQty = orderLineQty.pop();
        orderLines.pop();

        totalAmount -= lastTotal;
        totalItems -= lastQty;

        const list = document.getElementById("orderList");
        list.removeChild(list.lastElementChild);
        syncHiddenFields();
        setNotice("Last item removed.", false);
    }

    function clearCart() {
        totalAmount = 0;
        totalItems = 0;
        orderLines.length = 0;
        orderLineTotals.length = 0;
        orderLineQty.length = 0;
        document.getElementById("orderList").innerHTML = "";
        syncHiddenFields();
        setNotice("Cart cleared.", false);
    }

    function syncHiddenFields() {
        document.getElementById("totalAmount").innerText = totalAmount;
        document.getElementById("itemsSummary").value = orderLines.join(", ");
        document.getElementById("itemCount").value = totalItems;
        document.getElementById("finalTotalAmount").value = totalAmount;
    }

    function validateCheckout() {
        if (totalAmount <= 0) {
            setNotice("Add at least one item before checkout.", true);
            return false;
        }
        return true;
    }

    function setNotice(message, isError) {
        const notice = document.getElementById("orderNotice");
        notice.textContent = message;
        notice.style.background = isError ? "#fee2e2" : "#ecfdf5";
        notice.style.borderColor = isError ? "#fca5a5" : "#a7f3d0";
        notice.style.color = isError ? "#991b1b" : "#065f46";
    }

    loadMenu();
</script>

</body>
</html>
